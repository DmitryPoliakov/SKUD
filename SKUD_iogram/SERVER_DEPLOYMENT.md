# 🚀 Инструкция по развёртыванию исправлений на сервере

## 📋 Что исправлено

**Проблема:** Уведомления в Telegram не приходили из-за старой системы импорта бота.

**Решение:** Исправлена функция `notify_admin()` в `web_server.py` для использования прямых HTTP API вызовов.

## 🔧 Что НЕ НУЖНО делать

❌ **НЕ создавать новую службу `skud-api`**
❌ **НЕ запускать `api_server.py`** 

## ✅ Что нужно сделать на сервере

### 1. Остановить лишнюю службу (если запущена)
```bash
systemctl stop skud-api
systemctl disable skud-api
```

### 2. Скопировать исправленный файл
```bash
# Скопировать web_server.py на сервер в /home/SKUD_iogram/
```

### 3. Скопировать файл настроек сотрудников  
```bash
# Скопировать data/employee_telegram.json на сервер в /home/SKUD_iogram/data/
```

### 4. Перезапустить только нужные службы
```bash
systemctl restart skud-web
systemctl restart skud-bot
```

### 5. Проверить, что ESP32 обращается к правильному порту
ESP32 должен отправлять запросы на:
```
http://IP_СЕРВЕРА:5000/api/attendance
```

## 🔍 Как проверить, что всё работает

### 1. Проверить логи веб-сервера
```bash
tail -f /var/log/journal/skud-web.service
# или
journalctl -f -u skud-web
```

### 2. Проверить, что запросы от ESP32 обрабатываются
В логах должны появляться:
```
INFO - Получены данные: {'serial': '894046B8', 'time': '2025-08-14 09:08:41'}
INFO - Уведомление успешно отправлено администратору: СКУД: Тарасов Никита: приход в 09:08 (2025-08-14)
```

### 3. Проверить Telegram уведомления
- Администратор должен получать: "СКУД: Поляков Павел: приход в 09:15 (2025-08-14)"
- Сотрудники (если настроены ID) получают персональные сообщения

## ⚙️ Текущая архитектура (2 службы)

```
┌─────────────────┐    ┌──────────────────┐
│   ESP32 СКУД    │───▶│   skud-web       │ ◄── Веб + API
│   Считыватель   │    │   (web_server.py) │
└─────────────────┘    └──────────────────┘
                                │
                                ▼
                       ┌──────────────────┐
                       │   Telegram API   │ ◄── HTTP уведомления
                       └──────────────────┘
                                │
                                ▼
                       ┌──────────────────┐
                       │   skud-bot       │ ◄── Telegram бот
                       │   (bot.py)       │
                       └──────────────────┘
```

## 🔄 Если что-то не работает

### Проблема: ESP32 не может подключиться
```bash
# Проверить, что веб-сервер слушает на всех интерфейсах
netstat -tlnp | grep :5000
# Должно показать 0.0.0.0:5000
```

### Проблема: Telegram уведомления не приходят
```bash
# Проверить логи на ошибки HTTP API
journalctl -u skud-web | grep -i "telegram\|error\|ошибка"
```

### Проблема: Веб-интерфейс не работает
```bash
# Проверить статус службы
systemctl status skud-web
```

## 📱 Настройка уведомлений сотрудникам

Отредактировать файл `/home/SKUD_iogram/data/employee_telegram.json`:
```json
{
    "Поляков Павел": 123456789,
    "Тарасов Никита": null,
    "Поляков Дмитрий": null
}
```

Где `123456789` - это Telegram ID сотрудника (получить через @userinfobot).

## ✅ Готово!

После выполнения этих шагов:
- ✅ Уведомления администратору будут работать
- ✅ Веб-интерфейс будет работать 
- ✅ Отчёты будут генерироваться
- ✅ Опционально: персональные уведомления сотрудникам
- ✅ Только 2 службы вместо 3
