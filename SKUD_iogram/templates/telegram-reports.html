{% extends "base.html" %}

{% block title %}–û—Ç—á–µ—Ç—ã –°–ö–£–î - Telegram WebApp{% endblock %}

{% block extra_head %}
<style>
/* –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è Telegram WebApp */
body {
    font-size: 14px;
    margin: 0;
    padding: 10px;
}

.container-fluid {
    padding: 0;
}

.card {
    margin-bottom: 15px;
    border-radius: 8px;
}

.card-body {
    padding: 15px;
}

.btn {
    border-radius: 6px;
    font-size: 12px;
    padding: 6px 12px;
}

.btn-sm {
    padding: 4px 8px;
    font-size: 11px;
}

/* –î–ª—è WebApp - –¥–µ–ª–∞–µ–º –∫–Ω–æ–ø–∫–∏ –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É —Å gap */
.d-flex.gap-2 {
    gap: 8px !important;
}

/* –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã */
.row {
    margin: 0;
}

.col-md-6, .col-md-12 {
    padding: 5px;
}

/* –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è */
@media (max-width: 480px) {
    .card-title {
        font-size: 1.5rem;
    }
    
    .btn {
        font-size: 11px;
        padding: 5px 8px;
    }
    
    .btn-lg {
        font-size: 14px;
        padding: 8px 16px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1><i class="fas fa-chart-bar"></i> –û—Ç—á–µ—Ç—ã –°–ö–£–î</h1>
        {% if tg_webapp %}
        <p class="text-muted">Telegram WebApp - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ –ø—Ä–æ—Å–º–æ—Ç—Ä –æ—Ç—á–µ—Ç–æ–≤</p>
        {% else %}
        <p class="text-muted">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ –ø—Ä–æ—Å–º–æ—Ç—Ä –æ—Ç—á–µ—Ç–æ–≤ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏</p>
        {% endif %}
    </div>
</div>

<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card text-white bg-info">
            <div class="card-header">
                <i class="fas fa-users"></i> –°–µ–≥–æ–¥–Ω—è –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç
            </div>
            <div class="card-body">
                <h2 class="card-title">{{ today_present }}</h2>
                <p class="card-text">–∏–∑ {{ total_employees }} —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</p>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card text-white bg-primary">
            <div class="card-header">
                <i class="fas fa-percentage"></i> –ü—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ
            </div>
            <div class="card-body">
                <h2 class="card-title">{{ "%.0f"|format((today_present / total_employees * 100) if total_employees > 0 else 0) }}%</h2>
                <p class="card-text">–æ—Ç –æ–±—â–µ–≥–æ —á–∏—Å–ª–∞</p>
            </div>
        </div>
    </div>
</div>

<!-- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞ -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-file-excel"></i> –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞
            </div>
            <div class="card-body">
                <form method="POST" action="/generate_report" id="reportForm">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="year" class="form-label">–ì–æ–¥:</label>
                            <select name="year" id="year" class="form-select" required>
                                {% for year in available_years %}
                                <option value="{{ year }}" {% if loop.last %}selected{% endif %}>{{ year }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="month" class="form-label">–ú–µ—Å—è—Ü:</label>
                            <select name="month" id="month" class="form-select" required>
                                {% for month_num, month_name in months.items() %}
                                <option value="{{ month_num }}">{{ month_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="mt-3">
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="fas fa-download"></i> –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—Ç—á–µ—Ç—ã -->
{% if recent_reports %}
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-history"></i> –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—Ç—á–µ—Ç—ã
            </div>
            <div class="card-body">
                <div class="list-group">
                    {% for report in recent_reports %}
                    <div class="list-group-item">
                        <div class="d-flex flex-column">
                            <div class="mb-2">
                                <i class="fas fa-file-excel text-success"></i>
                                <strong>{{ report.name }}</strong>
                            </div>
                            <div class="d-flex gap-2 flex-wrap">
                                <a href="/download_report/{{ report.filename }}" class="btn btn-sm btn-outline-primary flex-fill">
                                    <i class="fas fa-download"></i> –°–∫–∞—á–∞—Ç—å
                                </a>
                                {% if tg_webapp %}
                                <button class="btn btn-sm btn-outline-info flex-fill" onclick="viewReport('{{ report.name }}', '/download_report/{{ report.filename }}')">
                                    <i class="fas fa-paper-plane"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- –°–ø—Ä–∞–≤–∫–∞ –¥–ª—è Telegram WebApp -->
{% if tg_webapp %}
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card bg-light">
            <div class="card-body">
                <h5><i class="fas fa-info-circle"></i> –°–ø—Ä–∞–≤–∫–∞</h5>
                <ul>
                    <li><strong>–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç</strong> - —Å–æ–∑–¥–∞–µ—Ç Excel —Ñ–∞–π–ª –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ —á–∞—Ç</li>
                    <li><strong>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</strong> - –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –æ—Ç—á–µ—Ç –≤ —á–∞—Ç</li>
                    <li>–û—Ç—á–µ—Ç—ã —Å–æ–¥–µ—Ä–∂–∞—Ç –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å, –æ—Ç—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —á–∞—Å—ã –∏ –≥—Ä–∞—Ñ–∏–∫–∏</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
{% if tg_webapp %}
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
// –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ SDK –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º WebApp
function initTelegramWebApp() {
    console.log('üîç Checking Telegram WebApp availability...');
    
    if (window.Telegram && window.Telegram.WebApp) {
        const tg = window.Telegram.WebApp;
        
        console.log('‚úÖ Telegram WebApp found');
        console.log('üì± WebApp object:', tg);
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ WebApp
        tg.ready();
        tg.expand();
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É Telegram
        document.body.style.backgroundColor = tg.backgroundColor || '#ffffff';
        document.body.style.color = tg.textColor || '#000000';
        
        console.log('‚úÖ Telegram WebApp initialized');
        console.log('üì± WebApp size:', tg.viewportHeight, 'x', tg.viewportStableHeight);
        console.log('üì± Platform:', tg.platform);
        console.log('üì± Version:', tg.version);
        
        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ WebApp
        window.tgWebApp = tg;
        
        return true;
    } else {
        console.log('‚ùå Telegram WebApp not available');
        return false;
    }
}

// –ü—ã—Ç–∞–µ–º—Å—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å—Ä–∞–∑—É
if (!initTelegramWebApp()) {
    // –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å, –∂–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ DOM
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üîÑ Retrying WebApp initialization after DOM loaded...');
        setTimeout(initTelegramWebApp, 100);
    });
}

// Telegram WebApp —Ñ—É–Ω–∫—Ü–∏–∏
function viewReport(reportName, reportUrl) {
    console.log('üîç viewReport called:', reportName, reportUrl);
    console.log('üîç window.tgWebApp exists:', !!window.tgWebApp);
    console.log('üîç window.Telegram exists:', !!window.Telegram);
    
    if (window.tgWebApp) {
        const tg = window.tgWebApp;
        
        const dataToSend = {
            action: 'view_report',
            report_name: reportName,
            report_url: window.location.origin + reportUrl
        };
        
        console.log('üì§ Sending view_report data:', dataToSend);
        
        try {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –±–æ—Ç—É
            tg.sendData(JSON.stringify(dataToSend));
            console.log('‚úÖ Data sent successfully');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã
            alert('üì§ –î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –±–æ—Ç—É: ' + reportName);
            
            console.log('üîí Closing WebApp after view_report');
            setTimeout(() => tg.close(), 1000); // –ó–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –ø–æ–∫–∞–∑–∞ alert
        } catch (error) {
            console.error('‚ùå Error sending data:', error);
            alert('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
        }
    } else {
        console.log('‚ùå Telegram WebApp –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
        console.log('üîß –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É');
        alert('Telegram WebApp –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
    }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞
document.getElementById('reportForm').addEventListener('submit', function(e) {
    console.log('üîç Form submit triggered');
    console.log('üîç window.Telegram exists:', !!window.Telegram);
    console.log('üîç window.Telegram.WebApp exists:', !!(window.Telegram && window.Telegram.WebApp));
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ª–∏ –º—ã –≤ Telegram WebApp
    const isRealWebApp = window.tgWebApp && 
                        window.tgWebApp.initData && 
                        window.tgWebApp.initData.length > 0;
    
    console.log('üîç Real WebApp detected:', isRealWebApp);
    console.log('üîç WebApp initData:', window.tgWebApp?.initData);
    
    if (isRealWebApp) {
        console.log('‚úÖ Real WebApp detected, preventing default submit');
        e.preventDefault();
        
        const formData = new FormData(this);
        const year = formData.get('year');
        const month = formData.get('month');
        
        const tg = window.tgWebApp;
        
        const dataToSend = {
            action: 'generate_report',
            year: year,
            month: month,
            report_type: 'excel'
        };
        
        console.log('üì§ Sending data to bot:', dataToSend);
        
        try {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –±–æ—Ç—É –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞
            tg.sendData(JSON.stringify(dataToSend));
            console.log('‚úÖ Generate report data sent successfully');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã
            alert('üìä –ó–∞–ø—Ä–æ—Å –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –æ—Ç—á–µ—Ç–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –±–æ—Ç—É!');
            
            console.log('üîí Closing WebApp after generate_report');
            setTimeout(() => tg.close(), 1000); // –ó–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –ø–æ–∫–∞–∑–∞ alert
        } catch (error) {
            console.error('‚ùå Error sending generate report data:', error);
            alert('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞: ' + error.message);
        }
    } else {
        console.log('üåê –û–±—ã—á–Ω—ã–π –≤–µ–±-–±—Ä–∞—É–∑–µ—Ä - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã');
        // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ –≤–µ–±–∞
        const submitBtn = this.querySelector('button[type="submit"]');
        if (submitBtn) {
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è...';
            submitBtn.disabled = true;
        }
        // –§–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è –æ–±—ã—á–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º —á–µ—Ä–µ–∑ POST /generate_report
    }
});

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
document.addEventListener('DOMContentLoaded', function() {
    const currentMonth = new Date().getMonth() + 1;
    document.getElementById('month').value = currentMonth;
});
</script>
{% else %}
<script>
// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞ –¥–ª—è –æ–±—ã—á–Ω–æ–π –≤–µ–±-—Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    const currentMonth = new Date().getMonth() + 1;
    document.getElementById('month').value = currentMonth;
});
</script>
{% endif %}
{% endblock %}
