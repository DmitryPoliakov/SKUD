#!/bin/bash

# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð¡ÐšÐ£Ð” Ð±Ð¾Ñ‚Ð° Ð½Ð° Linux ÑÐµÑ€Ð²ÐµÑ€Ðµ

echo "ðŸš€ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¡ÐšÐ£Ð” Ð±Ð¾Ñ‚Ð° Ð½Ð° Linux ÑÐµÑ€Ð²ÐµÑ€Ðµ"
echo "========================================"

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Ð¼Ñ‹ Ð² Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾Ð¹ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸
if [ ! -f "bot.py" ]; then
    echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: Ñ„Ð°Ð¹Ð» bot.py Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð² Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¹ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸"
    echo "Ð£Ð±ÐµÐ´Ð¸Ñ‚ÐµÑÑŒ, Ñ‡Ñ‚Ð¾ Ð²Ñ‹ Ð½Ð°Ñ…Ð¾Ð´Ð¸Ñ‚ÐµÑÑŒ Ð² Ð¿Ð°Ð¿ÐºÐµ SKUD_iogram"
    exit 1
fi

# 1. ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ Ð¸ ÑƒÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Python Ð¸ pip
echo "ðŸ“¦ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹ Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹..."
apt update
apt install -y python3 python3-pip python3-venv

# 2. Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ
echo "ðŸ”§ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ..."
python3 -m venv venv

# 3. ÐÐºÑ‚Ð¸Ð²Ð¸Ñ€ÑƒÐµÐ¼ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ
echo "âš¡ ÐÐºÑ‚Ð¸Ð²Ð°Ñ†Ð¸Ñ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ..."
source venv/bin/activate

# 4. Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
echo "ðŸ“š Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Python Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹..."
pip install --upgrade pip
pip install aiogram==3.13.1
pip install requests

# ÐŸÑ‹Ñ‚Ð°ÐµÐ¼ÑÑ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ (Ð¼Ð¾Ð³ÑƒÑ‚ Ð¿Ð¾Ñ‚Ñ€ÐµÐ±Ð¾Ð²Ð°Ñ‚ÑŒ ÐºÐ¾Ð¼Ð¿Ð¸Ð»ÑÑ†Ð¸Ð¸)
echo "ðŸ“Š ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ñ… Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹..."
pip install pandas matplotlib seaborn xlsxwriter python-dotenv || echo "âš ï¸ ÐÐµÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹ (Ð½Ðµ ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ð¾ Ð´Ð»Ñ Ð±Ð°Ð·Ð¾Ð²Ð¾Ð¹ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹)"

# 5. Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ñ…
echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¹..."
mkdir -p data/reports
mkdir -p logs

# 6. Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ ÐµÑÐ»Ð¸ Ð¸Ñ… Ð½ÐµÑ‚
if [ ! -f "data/employees.json" ]; then
    echo "ðŸ‘¥ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ‚ÐµÑÑ‚Ð¾Ð²Ð¾Ð³Ð¾ Ñ„Ð°Ð¹Ð»Ð° ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ¾Ð²..."
    cat > data/employees.json << 'EOF'
{
    "992BEE97": "ÐŸÐ¾Ð»ÑÐºÐ¾Ð² ÐŸÐ°Ð²ÐµÐ»",
    "894046B8": "Ð¢Ð°Ñ€Ð°ÑÐ¾Ð² ÐÐ¸ÐºÐ¸Ñ‚Ð°",
    "92C2001D": "ÐŸÐ¾Ð»ÑÐºÐ¾Ð² Ð”Ð¼Ð¸Ñ‚Ñ€Ð¸Ð¹",
    "E9DBA5A3": "Ð¨ÑƒÑ€Ð°",
    "32AABBD6": "ÐŸÐ¾Ð»ÑÐºÐ¾Ð² ÐŸÐ°Ð²ÐµÐ»",
    "296DD1A3": "ÐŸÑƒÑ‰Ð¸Ð½ÑÐºÐ¸Ð¹ ÐœÐ°Ñ€Ðº",
    "97D3A7DD": "ÐŸÐ°Ð»ÐºÐ¸Ð½ Ð¡ÐµÐ¼Ñ‘Ð½"
}
EOF
fi

if [ ! -f "data/attendance.csv" ]; then
    echo "ðŸ“Š Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ‚ÐµÑÑ‚Ð¾Ð²Ð¾Ð³Ð¾ Ñ„Ð°Ð¹Ð»Ð° Ð¿Ð¾ÑÐµÑ‰Ð°ÐµÐ¼Ð¾ÑÑ‚Ð¸..."
    cat > data/attendance.csv << 'EOF'
date,employee,arrival,departure
2025-01-08,ÐŸÐ¾Ð»ÑÐºÐ¾Ð² ÐŸÐ°Ð²ÐµÐ»,09:15,17:30
2025-01-08,Ð¢Ð°Ñ€Ð°ÑÐ¾Ð² ÐÐ¸ÐºÐ¸Ñ‚Ð°,08:45,18:00
2025-01-08,Ð¨ÑƒÑ€Ð°,10:00,16:45
2025-01-09,ÐŸÐ¾Ð»ÑÐºÐ¾Ð² ÐŸÐ°Ð²ÐµÐ»,09:05,17:15
2025-01-09,Ð¢Ð°Ñ€Ð°ÑÐ¾Ð² ÐÐ¸ÐºÐ¸Ñ‚Ð°,08:50,17:45
2025-01-09,ÐŸÑƒÑ‰Ð¸Ð½ÑÐºÐ¸Ð¹ ÐœÐ°Ñ€Ðº,09:30,18:30
EOF
fi

# 7. Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ systemd service Ñ„Ð°Ð¹Ð»
echo "ðŸ”§ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ systemd service..."
cat > /etc/systemd/system/skud-bot.service << EOF
[Unit]
Description=SKUD Telegram Bot
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/home/SKUD_iogram
Environment=PATH=/home/SKUD_iogram/venv/bin
ExecStart=/home/SKUD_iogram/venv/bin/python bot_simple.py
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

# 8. ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ systemd
systemctl daemon-reload

echo ""
echo "âœ… ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°!"
echo ""
echo "ðŸš€ Ð”Ð»Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð±Ð¾Ñ‚Ð° Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ:"
echo "   source venv/bin/activate"
echo "   python bot_simple.py"
echo ""
echo "ðŸ”§ Ð”Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐºÐ° ÐºÐ°Ðº ÑÐ»ÑƒÐ¶Ð±Ñ‹:"
echo "   systemctl enable skud-bot"
echo "   systemctl start skud-bot"
echo "   systemctl status skud-bot"
echo ""
echo "ðŸ“ Ð›Ð¾Ð³Ð¸ ÑÐ»ÑƒÐ¶Ð±Ñ‹:"
echo "   journalctl -u skud-bot -f"
echo ""
echo "âš ï¸  Ð’ÐÐ–ÐÐž: ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚Ðµ Ñ‚Ð¾ÐºÐµÐ½ Ð² config.py Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð´Ð°ÐºÑˆÐµÐ½Ð°!"
echo ""
