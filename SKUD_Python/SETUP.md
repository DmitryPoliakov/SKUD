# Инструкция по настройке и запуску СКУД на Python

## Подготовка окружения

### 1. Установка Python

Если Python не установлен:
1. Скачайте Python 3.8 или выше с [официального сайта](https://www.python.org/downloads/)
2. Установите Python, отметив опцию "Add Python to PATH" при установке

### 2. Создание виртуального окружения (рекомендуется)

```bash
# Windows
python -m venv venv
venv\Scripts\activate

# Linux/Mac
python3 -m venv venv
source venv/bin/activate
```

### 3. Установка зависимостей

```bash
pip install -r requirements.txt
```

## Настройка компонентов

### 1. Настройка Flask API

По умолчанию Flask API запускается на порту 5000. Если нужно изменить порт или другие параметры, отредактируйте файл `app/main.py`:

```python
if __name__ == '__main__':
    logger.info("Запуск сервера СКУД")
    app.run(host='0.0.0.0', port=5000, debug=True)
```

### 2. Настройка Telegram бота

1. Создайте бота в Telegram:
   - Найдите @BotFather в Telegram
   - Отправьте команду `/newbot`
   - Следуйте инструкциям для создания бота
   - Скопируйте полученный токен

2. Откройте файл `app/telegram_bot.py` и замените:
   ```python
   TELEGRAM_TOKEN = "YOUR_TELEGRAM_BOT_TOKEN"  # Замените на свой токен
   ```

3. Добавьте ID пользователей, которым разрешен доступ к боту:
   ```python
   ALLOWED_USERS = [123456789, 987654321]  # Замените на реальные ID
   ```

   Чтобы узнать свой ID в Telegram, можно использовать бота @userinfobot

### 3. Настройка ESP32

1. Откройте файл `RFID_RC522_Tracker_Python.ino` в Arduino IDE
2. Установите необходимые библиотеки через Arduino Library Manager:
   - WiFi
   - HTTPClient
   - ArduinoJson
   - MFRC522

3. Измените настройки WiFi:
   ```cpp
   const char* primary_ssid = "ваш_ssid";
   const char* primary_password = "ваш_пароль";
   ```

4. Укажите IP-адрес вашего сервера:
   ```cpp
   const char* serverURL = "http://192.168.1.100:5000/api/attendance";
   ```
   Замените `192.168.1.100` на IP-адрес компьютера, на котором запущен Flask API

5. При необходимости настройте часовой пояс:
   ```cpp
   const long gmtOffset_sec = 18000; // GMT+5 (Уральское время)
   ```

6. Загрузите скетч в ESP32

### 4. Настройка автоматического закрытия дней

По умолчанию незавершенные дни закрываются в 00:01 с временем ухода 17:00. Если нужно изменить эти параметры:

1. Для изменения времени закрытия дней откройте `run.py`:
   ```python
   schedule.every().day.at("00:01").do(run_auto_close)
   ```

2. Для изменения времени ухода по умолчанию откройте `app/auto_close.py`:
   ```python
   DEFAULT_END_TIME = "17:00"
   ```

## Запуск системы

### Запуск всех компонентов сразу

```bash
python run.py
```

Это запустит Flask API, Telegram бота и планировщик задач в одном процессе.

### Запуск компонентов по отдельности (для отладки)

1. Запуск Flask API:
   ```bash
   python app/main.py
   ```

2. Запуск Telegram бота:
   ```bash
   python app/telegram_bot.py
   ```

3. Запуск автоматического закрытия дней вручную:
   ```bash
   python app/auto_close.py
   ```

## Проверка работоспособности

### Проверка Flask API

1. Откройте в браузере: `http://localhost:5000/api/health`
2. Должен отобразиться JSON с сообщением о работоспособности API

### Проверка Telegram бота

1. Найдите своего бота в Telegram
2. Отправьте команду `/start`
3. Бот должен ответить приветственным сообщением
4. Отправьте команду `/report` и выберите период для отчета

### Проверка ESP32

1. Подключите ESP32 к питанию
2. Поднесите RFID-карту к считывателю
3. В мониторе порта Arduino IDE должны появиться сообщения об отправке данных
4. В логах Flask API должны появиться сообщения о получении данных

## Устранение неполадок

### Flask API не запускается

1. Проверьте, не занят ли порт 5000 другим приложением:
   ```bash
   # Windows
   netstat -ano | findstr :5000
   
   # Linux/Mac
   lsof -i :5000
   ```
2. Измените порт в `app/main.py` если необходимо

### Telegram бот не отвечает

1. Проверьте правильность токена в `app/telegram_bot.py`
2. Убедитесь, что ваш ID добавлен в список `ALLOWED_USERS`
3. Проверьте логи в файле `telegram_bot.log`

### ESP32 не отправляет данные

1. Проверьте подключение к WiFi
2. Убедитесь, что IP-адрес сервера указан правильно
3. Проверьте, что Flask API запущен и доступен
4. Проверьте подключение RC522 к ESP32 согласно схеме

## Регулярное обслуживание

### Резервное копирование данных

Рекомендуется регулярно создавать резервные копии файлов:
- `data/attendance.csv` - данные посещаемости
- `data/employees.json` - список сотрудников

### Обновление списка сотрудников

Для добавления новых сотрудников отредактируйте файл `data/employees.json`:
```json
{
  "992BEE97": "Поляков",
  "894046B8": "Тарасов",
  "НОВЫЙ_ID": "Новый сотрудник"
}
```

### Очистка старых отчетов

Периодически очищайте директорию `data/reports/` от старых отчетов. 