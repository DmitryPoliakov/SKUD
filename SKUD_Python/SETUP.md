# Настройка системы СКУД на Python

## Требования

### Аппаратное обеспечение
- **ESP32-C3-MINI-1** или совместимая плата
- **RFID-считыватель RC522** (13.56 МГц)
- **Светодиоды** (зеленый и красный) для индикации
- **Соединительные провода**
- **Компьютер или сервер** для запуска Python-части системы

### Программное обеспечение
- **Arduino IDE** для прошивки ESP32
- **Python 3.8+** для серверной части
- **Telegram аккаунт** для создания бота

## Установка и настройка

### 1. Настройка аппаратной части (ESP32 + RC522)

#### Схема подключения
```
+-----------+----------------+
| RC522     | ESP32-C3       |
+-----------+----------------+
| SDA (SS)  | GPIO6 (D4)     |
| SCK       | GPIO8 (D8)     |
| MOSI      | GPIO10 (D10)   |
| MISO      | GPIO9 (D9)     |
| GND       | GND            |
| RST       | GPIO7 (D5)     |
| 3.3V      | 3V3            |
+-----------+----------------+
```

#### Подключение светодиодов
- **Зеленый светодиод**: к пину GPIO4 через резистор 220-330 Ом
- **Красный светодиод**: к пину GPIO5 через резистор 220-330 Ом

#### Установка Arduino IDE и библиотек
1. Установите **Arduino IDE** с официального сайта
2. Добавьте поддержку ESP32:
   - Откройте File → Preferences
   - Добавьте в "Additional Board Manager URLs": `https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json`
   - Откройте Tools → Board → Boards Manager, найдите "esp32" и установите
3. Установите необходимые библиотеки через Library Manager:
   - `MFRC522` by Miguel Balboa
   - `WiFi` (встроена в ESP32)
   - `HTTPClient` (встроена в ESP32)
   - `ArduinoJson` by Benoit Blanchon
   - `ESPmDNS` (встроен в ESP32)
   - `WiFiUdp` (встроен в ESP32)
   - `ArduinoOTA` (встроен в ESP32)

#### Настройка и прошивка ESP32
1. Откройте файл `RFID_RC522_Tracker_Python/RFID_RC522_Tracker_Python.ino`
2. Настройте параметры WiFi:
   ```cpp
   const char* primary_ssid = "ваш_ssid";
   const char* primary_password = "ваш_пароль";
   const char* backup_ssid = "резервный_ssid";
   const char* backup_password = "резервный_пароль";
   ```
3. Настройте URL сервера:
   ```cpp
   const char* serverURL = "http://ваш_IP_адрес:5000/api/attendance";
   ```
4. Выберите плату: Tools → Board → ESP32 Arduino → ESP32C3 Dev Module
5. Выберите порт: Tools → Port
6. Загрузите скетч: Sketch → Upload

#### OTA (Over-The-Air) обновление
Система поддерживает обновление прошивки по WiFi:
1. Убедитесь, что ESP32 подключен к той же сети, что и компьютер с Arduino IDE
2. В Arduino IDE выберите Tools → Port → Network Ports и найдите ваш ESP32
3. Загрузите новую версию скетча через OTA

**Примечание**: Для первого OTA-обновления может потребоваться пароль. Его можно установить в коде при необходимости.

### 2. Настройка серверной части (Python)

#### Установка зависимостей
1. Установите Python 3.8 или выше
2. Откройте терминал в директории проекта
3. Установите зависимости:
   ```bash
   pip install -r requirements.txt
   ```

#### Настройка Telegram бота
1. Создайте бота через @BotFather в Telegram и получите токен
2. Откройте файл `app/telegram_bot.py` и настройте:
   ```python
   TELEGRAM_TOKEN = "ваш_токен_бота"
   ALLOWED_USERS = [ваш_user_id]  # ID пользователей с доступом
   ADMIN_USER_ID = ваш_user_id    # ID для уведомлений
   ```
3. Чтобы узнать ваш user_id, отправьте сообщение боту и проверьте логи или используйте специального бота, например @userinfobot

#### Настройка данных
- Файлы данных находятся в директории `data/`
- При первом запуске будут созданы файлы `employees.json` и `attendance.csv` с тестовыми данными
- Вы можете отредактировать `employees.json`, чтобы добавить своих сотрудников

### 3. Запуск системы

#### Автоматический запуск (все компоненты)
```bash
python run.py
```
Или в Windows:
```cmd
start.bat
```

Это запустит:
- Flask API на порту 5000 (доступно по http://localhost:5000)
- Telegram бота для отчетов и уведомлений
- Планировщик автоматического закрытия дней

#### Ручной запуск отдельных компонентов
- Только веб-сервер и API:
  ```bash
  python -m app.main
  ```
- Только Telegram бот:
  ```bash
  python app/telegram_bot.py
  ```
- Только автоматическое закрытие дней:
  ```bash
  python app/auto_close.py
  ```

## Проверка работы системы

### Проверка ESP32
1. Откройте Serial Monitor в Arduino IDE (Tools → Serial Monitor, 115200 baud)
2. Проверьте, что ESP32 подключается к WiFi
3. Проверьте, что время синхронизируется через NTP
4. Приложите RFID-карту и убедитесь, что данные отправляются на сервер

**Индикация светодиодами**:
- **Зеленый (постоянно, низкая яркость)** - режим ожидания, все системы работают
- **Зеленый (мигание)** - успешное считывание карты
- **Красный (мигание периодическое)** - нет WiFi или синхронизации времени
- **Красный (быстрое мигание)** - ошибка при отправке данных или обработки

### Проверка веб-интерфейса
1. Откройте браузер и перейдите на http://localhost:5000
2. Убедитесь, что отображается панель управления
3. Проверьте разделы "Посещаемость", "Сотрудники" и "Отчеты"

### Проверка Telegram бота
1. Найдите вашего бота в Telegram
2. Отправьте команду `/start`
3. Убедитесь, что бот отвечает и показывает меню
4. Попробуйте команду `/report` для получения отчета

## Устранение неполадок

### ESP32 не подключается к WiFi
- Проверьте правильность SSID и пароля в коде
- Убедитесь, что сигнал WiFi достаточно сильный
- Проверьте, не блокирует ли роутер подключение устройства
- Попробуйте подключиться к другой сети

### RFID-карты не считываются
- Проверьте правильность подключения RC522 согласно схеме
- Убедитесь, что карты соответствуют частоте 13.56 МГц (MIFARE)
- Проверьте в Serial Monitor сообщения об инициализации RC522

### Telegram бот не отвечает
- Проверьте правильность токена в `telegram_bot.py`
- Убедитесь, что ваш user_id добавлен в ALLOWED_USERS
- Проверьте логи `telegram_bot.log` на наличие ошибок
- Убедитесь, что бот запущен (либо через `run.py`, либо отдельно)

### Веб-интерфейс недоступен
- Убедитесь, что Flask сервер запущен
- Проверьте, что порт 5000 не заблокирован брандмауэром
- Попробуйте открыть http://127.0.0.1:5000 вместо localhost
- Проверьте логи `app.log` на наличие ошибок

### Данные не записываются
- Проверьте права доступа к директории `data/`
- Убедитесь, что файлы `attendance.csv` и `employees.json` доступны для записи
- Проверьте логи на наличие ошибок записи

## Дополнительная информация

- **Логи системы** хранятся в корневой директории проекта:
  - `app.log` - логи веб-сервера и API
  - `telegram_bot.log` - логи бота
  - `auto_close.log` - логи автоматического закрытия дней
  - `skud.log` - общий системный лог
- **OTA обновление** позволяет обновлять прошивку ESP32 без физического подключения. Для этого используйте Arduino IDE с поддержкой OTA.
- **Резервное копирование**: регулярно сохраняйте копии файлов из директории `data/` для предотвращения потери данных.
